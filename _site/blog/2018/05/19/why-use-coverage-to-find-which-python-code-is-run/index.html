<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <title> Why use coverage to find which parts of a python code were executed? </title> <meta name="description" content="Case Study - How we decided that coverage was the best option for detecting false positives in vulture."> <meta name="author" content="Rahul Jha"> <meta content='user-scalable=no, width=device-width, initial-scale=1.0' name='viewport'> <meta name="google-site-verification" content="x2EpQdOMz-k9fP8hak9I3COaXhnQ4jNLp2GU4GYQ8jM" /> <link href='//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic|Open+Sans:300italic,700italic,400,700,300' rel='stylesheet' type='text/css'> <link rel="shortcut icon" href="/assets/favicon.png"> <style type="text/css"> /* http://meyerweb.com/eric/tools/css/reset/ v2.0 | 20110126 License: none (public domain) */ html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video { margin: 0; padding: 0; border: 0; font-size: 100%; font: inherit; vertical-align: baseline; } /* HTML5 display-role reset for older browsers */ article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section { display: block; } body { line-height: 1; } ol, ul { list-style: none; } blockquote, q { quotes: none; } blockquote:before, blockquote:after, q:before, q:after { content: ''; content: none; } table { border-collapse: collapse; border-spacing: 0; } .clearfix:after { content: "."; display: block; clear: both; visibility: hidden; line-height: 0; height: 0; } .clearfix { display: inline-block; } html[xmlns] .clearfix { display: block; } * html .clearfix { height: 1%; } @font-face { font-family: 'anonymousregular'; src: url('/assets/fonts/Anonymous-webfont.eot'); src: url('/assets/fonts/Anonymous-webfont.eot?#iefix') format('embedded-opentype'), url('/assets/fonts/Anonymous-webfont.woff') format('woff'), url('/assets/fonts/Anonymous-webfont.ttf') format('truetype'), url('/assets/fonts/Anonymous-webfont.svg#anonymousregular') format('svg'); font-weight: normal; font-style: normal; } body{ font-size: 15px; font-family: 'Droid Serif', serif; color: #545454; line-height: 25px; } #gradient{ height: 5px; background: rgba(237,82,82,0.64); background: -moz-linear-gradient(left, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); background: -webkit-gradient(left top, right top, color-stop(0%, rgba(237,82,82,0.64)), color-stop(20%, rgba(250,21,0,0.65)), color-stop(52%, rgba(237,82,82,0.66)), color-stop(80%, rgba(255,21,0,0.66)), color-stop(100%, rgba(237,82,82,0.67))); background: -webkit-linear-gradient(left, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); background: -o-linear-gradient(left, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); background: -ms-linear-gradient(left, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); background: linear-gradient(to right, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ed5252', endColorstr='#ed5252', GradientType=1 ); } /* STRUCTURE */ #container{ background-color: #fafafa; } #content{ width: 760px; margin: auto; margin-top: 20px; padding-bottom: 60px; padding-top: 40px; } /* FOOTER */ footer{ padding: 40px 0px; text-align: center; border-top: 1px solid #e6e6e6; font-size: 0.8em; color: #9a9a9a; background-color: #fafafa; } footer a{ color: #9a9a9a; } /* HEADER */ header{ width: 760px; margin: auto; height: 50px; border-bottom: 1px solid #f1f1f1; position: relative; } #more-nav{ font-size: 0.75em; display: inline-block;; position: absolute; top: 0px; font-family: "anonymousregular"; padding-top: 5px; right: 0px; } #more-nav a{ padding: 0px 2px; text-decoration: none; color: #545454; } #more-nav a:hover{ transition: 0s; background-image: linear-gradient(to bottom, #fff 30%, rgba(200, 200, 200, 0.4) 50%); background-repeat: repeat-x; background-size: 2px 2px; background-position: 0px 100%; } #more-nav .selected{ color: #ed5252; font-weight: bold; } #logo{ font-size: 1.2em; font-family: "anonymousregular"; margin-top: 20px; } #logo *{ text-decoration: none; } #logo1{ color: #999; } #logo2{ font-size: 0.8em; color: #ed5252; } #logo3{ color: #545454; } #logo a:hover{ color: #ed5252; transition-duration: 1s; } /* TEXT STRUCTURE */ h1, h2, h3, h4, h5{ font-family: 'Open Sans', sans-serif; color: #1c1c1c; } h2, h3, h4, h5{ text-transform: capitalize; } a:hover{ color: #ed5252; transition-duration:0.2s; } p a, ul a, .review a{ color: #763232; text-decoration: none; background-image: linear-gradient(to bottom, #fff 30%, rgba(200, 200, 200, 0.4) 50%); background-repeat: repeat-x; background-size: 2px 2px; background-position: 0px 100%; } p{ text-align: justify; margin-bottom: 20px; } .excerpt p{ margin-bottom: 0px; } .footnote, .sidenote{ margin: 40px 0px; color: #858585; text-align: right; font-size: 0.9em; font-style: italic; } .image_notes{ text-align: center; color: #858585; font-size: 0.9em; margin: -5px 0px 15px 0px; } h1{ font-size: 1.85em; text-align: center; margin: 70px 0px 20px 0px; line-height : 1.5em; } h1 em{ color: #888; font-weight: normal; font-size: 0.8em; } h2{ font-size: 1.75em; margin: 50px 0px 50px 0px; line-height: 1.75em; } h2::before{ content: "#"; color: #ed5252; font-family: "anonymousregular"; display: inline-block; float: left; padding: 3px 10px 0px 0px; font-size: 0.7em; } h3{ font-size: 1.35em; margin-bottom: 20px; } h4{ font-size: 1.2em; margin-bottom: 20px; font-style: italic; } h5{ font-size: 1.3em; margin-bottom: 20px; } h5 *{ color: #545454; } em{ font-style: italic; } strong{ font-weight: bold; } blockquote{ border-left: 3px solid #ddd; color: #888; margin: 0px 0px 20px 40px; font-style: italic; } blockquote p{ margin: 5px 20px !important; } ul{ padding-left: 40px; line-height: 25px; list-style: square; margin-bottom: 20px; } li{ display: list-item; } ol{ padding-left: 40px; line-height: 25px; margin-bottom: 20px; list-style-type: decimal; } /* TAGS */ .home-tag { font-size: 10px; display: inline-block; border: 1px solid #dedede; padding: 2px 2px 1px 2px; border-radius: 2px; line-height: 10px; margin-left: 1px; } .tag-date{ color: #dedede; } .tag-management { border-color: #929aff; color: #929aff; } .tag-programming { border-color: #ff9292; color: #ff9292; } .tag-coaching { border-color: #4ec698; color: #4ec698; } .tag-projectmanagement { border-color: #929aff; color: #929aff; } /* BLOG INDEX */ #all-posts{ margin: 0px auto 10px auto; width: 760px; } .single-post{ border-top: 1px solid #f1f1f1; padding: 40px 0px; float: clear; } .single-post:first-child{ border-top: none !important; } .single-post .date{ color: #cdcdcd; margin-top: 10px; float: right; } .single-post .author{ color: #cdcdcd; float: right; font-size: 0.7em; } .single-post .title{ font-family: 'Open Sans', sans-serif; font-size: 1.6em; margin-bottom: 20px; line-height: 1.6em; position: relative; } .single-post .title a{ color: #545454; text-decoration: none; } .single-post .title a::before{ content: "→"; opacity: 0; font-family: "anonymousregular"; font-size: 0.7em; position: absolute; left: -30px; transition: all .4s ease-in-out; } .single-post .title a:hover::before{ opacity: 1; transition: all .4s ease-in-out; color: #ed5252; } .single-post .title em{ display: none; } .data_table{ border: 1px solid #efefef; font-family: "anonymousregular"; font-size: 12px; margin: auto auto 20px auto; } .data_table tr{ border: 1px solid #efefef; } .data_table th{ background-color: #efefef; } .data_table th, .data_table td{ padding: 2px 5px; } /* BOOKS */ .book-cover-entry{ width: 120px; margin-right: 20px; float: left; font-size: 12px; text-decoration: none !important; } .buy-book{ text-decoration: underline; } .book-cover-entry img{ width: 120px; } .book-cover-entry { background-image: none; } .book-rating .icon { display: inline-block; padding-right: 5px; } .book-rating .top .icon{ color: #1CED00; } .book-rating .good .icon{ color: #82ED00; } .book-rating .medium .icon{ color: #EDD100; } .book-rating .low .icon{ color: #EDAE00; } .book-rating .poor .icon{ color: #ED3B00; } #buy-title{ padding: 0px 0px 25px 0px; } #buy-title span{ font-size: 0.8em !important; color: #cdcdcd; } #buy-popin{ padding: 30px 15px; } .store{ display: block; padding: 15px 5px; text-decoration: none; } .store:hover{ color: #ed5252; } #upcoming-books{ padding-top: 20px; } #upcoming-books img{ height: 90px; margin-right: 10px; border: 1px solid #fff; } #upcoming-books a{ text-decoration: none; } #upcoming-books img:hover{ border: 1px solid #ed5252; } /* BLOG SHOW */ .post{ padding-top: 20px; } p code, li code{ background-color: #efefef; font-family: "Lucida Console", "Courier New", Courier, monospace; padding: 1px 2px; font-size: 13px; } .post img{ border: 1px solid #e6e6e6; padding: 5px; margin: 0px 0px 20px 20px; } .published span{ border-top: 1px solid #e6e6e6; display: inline-block; color: #858585; padding-top: 5px; font-family: 'Open Sans', sans-serif; font-size: 0.9em; padding: 5px 20px 0px 20px; } .published{ text-align: center; margin-bottom: 80px; } #more{ border-top: 1px solid #e6e6e6; margin-top: 40px; padding: 40px 0px; } #more-articles{ margin-bottom: 40px; } .image-wrapper em{ display: block; font-size: 0.8em; margin: -20px 0px 20px 0px; color: #aaa; } .twitter-tweet{ margin: auto; max-width: 420px !important; } #book-review{ border: 1px dashed #dedede; padding: 20px; margin-bottom: 20px; opacity: 0.7; font-style: italic; } /* Music */ .js_play_sound, .js_stop_sound{ display: inline-block; padding: 4px 10px 2px 10px; border: 1px solid #efefef; background-color: #efefef; margin-right: 10px; text-decoration: none; border-radius: 3px; font-family: 'anonymousregular'; font-size: 12px; } .js_play_sound:hover, .js_stop_sound:hover{ background-color: #dedede; } /* Comments */ #comments{ padding-top: 20px; } #show-disqus-arrow{ color: #ed5252; } /* CLEARFIX */ .cf:before, .cf:after { content: " "; /* 1 */ display: table; /* 2 */ } .cf:after { clear: both; } /************************ MOBILE LAYOUT *********************/ @media all and (max-width: 800px) { .home-tag { display: none; } .author{ float: none !important; display: inline; } header{ width: 92%; padding: 4%; height: 75px; position: relative; text-align: center; background-color: #fafafa; } #more-nav{ left: 0px; top: 50px; } #logo{ margin-top: 10px; } #content, #all-posts{ width: 92%; padding: 4%; } .image-wrapper{ width: 100%; } .image-wrapper img, .post div img, .post p img{ max-width: 100% !important; padding: 15px 0px !important; margin: 20px 0px 20px 0px !important; border-right: 0px; border-left: 0px; } .single-post .title{ font-size: 1.4em; } .date{ display: none; } h1{ font-size: 1.7em; width: 94%; padding: 3%; } h2{ font-size: 1.50em; margin: 30px 0px 30px 0px; line-height: 1.75em; } h3{ font-size: 1.30em; } blockquote{ margin: 0px 0px 20px 0px !important; } pre{ margin-left: 0px !important; margin-right: 0px !important; width: 90%; overflow-x: scroll; } code{ width: 100%; font-size: 13px !important; } footer div{ display: inline; } /* Hire me responsive */ #hire ul{ padding-left: 15px; } #talking-img{ width: 100%; } #talking-img img{ width: 100% !important; } #reviews{ border-top: 1px dashed #e6e6e6; padding: 15px 0px 15px 0px; } #references_logo{ padding: 0px 0px 15px 0px; } .review{ width: 100%; margin: 0px 0px 15px 0px; padding: 0px; border-bottom: 1px dashed #e6e6e6; } #references_logo img, #references_logo .minor{ width: 22%; float: left; margin: 15px 2% 15px 0px; } .data_table th, .data_table td{ font-size: 8px; padding: 0px; border: 1px solid #efefef; } } </style> </head> <body> <div id="gradient"></div> <header> <div id="logo"> <a id='logo1' href="/">RJ722</a> <span id='logo2'>#</span> <a id='logo3' href="/blog/"> blog </a> </div> <div id="more-nav"> &rarr; <a href="/blog/" class="selected">blog</a> &rarr; <a href="/hire/" class="">hire me</a> </div> </header> <h1> <span> Why use coverage to find which parts of a python code were executed? </span> </h1> <div class="published"> <span>19 May 2018</span> </div> <div id="container"> <div id="content"> <div class="post" id="post-"> <p>In this post, I’ll walk you through the decision making process the team behind Vulture underwent to come up with a way to deal with false positives in it’s results. Let’s first start with a brief introduction of <a href="https://github.com/jendrikseipp/vulture">Vulture</a>:</p> <h2 id="vulture">Vulture</h2> <p>As the name suggests, vulture helps find <a href="https://en.wikipedia.org/wiki/Dead_code">dead code</a> for Python programs. There are many reasons for dead code ending up in a project. The most common is refactoring, but another is misspellings, which are only detected at runtime for dynamic languages. Finding and removing dead code allows to keep the code base clean and reduces bugs.</p> <p>Vulture can detect unused imports, variables, attributes, functions, methods, properties and classes. Other than these, code after return statements and checking for a Boolean False (eg. <code class="highlighter-rouge">if False:</code> or <code class="highlighter-rouge">while 0:</code>) can also be detected.</p> <h3 id="using-vulture">Using vulture</h3> <p>Vulture is a standard Python package, that is installed with <code class="highlighter-rouge">pip</code>:</p> <div class="highlighter-rouge"><pre class="highlight"><code>(venv) $ pip install vulture
</code></pre></div> <p>Let us say that you have the following program (say <code class="highlighter-rouge">program.py</code>) on which you want to perform analysis:</p> <div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="c"># program.py</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">false_positive_function</span><span class="p">():</span>
    <span class="s">"""
    A function which is vital for your application to function, but Vulture
    reports it as unused.
    """</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">"Hello World"</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Hello World"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">hello_world</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div> <p>Analysing the program with vulture is as simple as running the following command:</p> <div class="highlighter-rouge"><pre class="highlight"><code>(venv) $ vulture program.py
</code></pre></div> <p>which would produce the following output (on <code class="highlighter-rouge">vulture 0.26</code>):</p> <div class="highlighter-rouge"><pre class="highlight"><code>program.py:2: unused import 'os' (90% confidence)
program.py:4: unused function 'false_positive_function' (60% confidence)
program.py:12: unused variable 'message' (60% confidence)
</code></pre></div> <p>As you can see, along with every result, vulture also reports a confidence value - which is a measure of how sure vulture is about that part of code being unused. This output can be made even more meaningful with the help of flags like <code class="highlighter-rouge">--min-confidence</code> and <code class="highlighter-rouge">--sort-by-size</code>. Read more about them <a href="https://github.com/jendrikseipp/vulture/tree/master/README.rst">here</a></p> <p>Owing to Python’s dynamic nature, Vulture is likely to miss some dead code. Also, code which is only implicitly used is reported unused, such as overloading a parent class method, overriding methods of C/C++ extensions, etc.</p> <p>Some other examples where vulture may report “useful” code as unused:</p> <ul> <li><strong>API Endpoints</strong> - They are meant for users and are not employed to any use directly in the source code, therefore confusing vulture.</li> <li><strong>ORM Schema</strong> - Again, they aren’t used by program’s source code directly.</li> </ul> <h3 id="handling-false-positives">Handling false positives</h3> <p>One way to prevent Vulture from reporting false positives is to explicitly use the code anyway.</p> <blockquote> <p>WHAT! - Are you telling me to run my already used code?</p> </blockquote> <p>Worry not! - no need to actually call the code - If you create a mocking class with attributes, name of whose exactly match the name of the unused code (variables, functions, classes, anything which can be unused and has a name), you can very cleverly fool Vulture into believing that that part of the code is being used (because Vulture keeps only track of the names parsed from the AST). This is known as “Whitelisting” and since it is a fairly common practice to create such a class for mocking objects, we already ship it with Vulture.</p> <p>Let me show how you can create your own whitelists with our previous example. (Remeber we had a <code class="highlighter-rouge">false_positive_function</code> - let’s whitelist it.)</p> <p>Note that I am calling this file <code class="highlighter-rouge">whitelist_program.py</code> because it’s a good idea to start the name with <code class="highlighter-rouge">whitelist</code> just so you know what that file does, but there is no such compulsion - You can call it whatever you want.</p> <div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="c"># whitelist_program.py</span>
<span class="kn">from</span> <span class="nn">vulture.whitelist_utils</span> <span class="kn">import</span> <span class="n">Whitelist</span>

<span class="n">awesome_whitelist</span> <span class="o">=</span> <span class="n">Whitelist</span><span class="p">()</span>

<span class="n">Whitelist</span><span class="o">.</span><span class="n">false_positive_function</span>
</code></pre></div> <p>Now, I am gonna run Vulture using the following command:</p> <div class="highlighter-rouge"><pre class="highlight"><code>(venv) $ vulture program.py whitelist_program.py
</code></pre></div> <p>And hurray, output does not contain the false positive function.</p> <div class="highlighter-rouge"><pre class="highlight"><code>program.py:2: unused import 'os' (90% confidence)
program.py:12: unused variable 'message' (60% confidence)
</code></pre></div> <p><strong>How did that work?</strong></p> <p>Since you also passed the whitelist file along with the file to be analysed, vulture created <code class="highlighter-rouge">ast</code>’s for both of them and while parsing those trees, Vulture created a common <code class="highlighter-rouge">set</code> for storing the names of used and defined objects. Since the name of the false positive function occurs in both of them, it is therefore not treated as unused.</p> <p>A thing you may find interesting and noteworthy about the <code class="highlighter-rouge">Whitelist</code> class is that it does absolutely “nothing”. It’s current implementation is as follows:</p> <div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Whitelist</span><span class="p">:</span>
    <span class="s">"""
    Helper class that allows mocking Python objects.
    Use it to create whitelist files that are not only syntactically
    correct, but can also be executed.
    """</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div> <p>Now, since whitelists are so extensively used, Vulture already comes <a href="https://github.com/jendrikseipp/vulture/tree/master/vulture/whitelists/">loaded for some popular libraries like <code class="highlighter-rouge">sys</code>, <code class="highlighter-rouge">collections</code>, <code class="highlighter-rouge">unittest</code>, etc.</a> - These whitelists are automatically “activated” as soon as the user imports that library. The developers at Vulture are working hard (gives a pat on his back) to ship even more of these. Guess what, you can add one for your library, or just open an issue and we would create one for you. PR’s are more than welcome! :-)</p> <p><strong>Some other ways of dealing with false poisitives:</strong></p> <ul> <li>Mark unused variables by starting them with an “<code class="highlighter-rouge">_</code>”. (e.g., <code class="highlighter-rouge">_x, y = get_pos()</code>)</li> <li>Use different files for API endpoints, ORM, etc. and exclude them with the help of <code class="highlighter-rouge">--exclude</code> flag.</li> </ul> <p>You can find more information about <a href="https://github.com/jendrikseipp/vulture/tree/master/README.rst">vulture in it’s documentation</a>.</p> <h2 id="what-more-does-vulture-want">What more does vulture want?</h2> <p>As we saw earlier, the results reported by vulture sometimes contain false positives. We want to be able to develop such a system which should be able to detect wether or not the result given by vulture is a false positive.</p> <p>Please note that this discussion originally occurred on <a href="https://github.com/jendrikseipp/vulture/issues/109">jendrikseipp/vulture/#109</a> and this post is going to be a translation with some insight on how we finally came up with a decision.</p> <h3 id="approach-1---user-employed-regular-expressions">Approach 1 - User employed regular expressions</h3> <p>Vulture has different methods for parsing different kind of nodes in an <code class="highlighter-rouge">ast</code>. So for example, if Vulture encounters a function definition, it triggers the <code class="highlighter-rouge">visitFunctionDef</code> method for parsing that node and similarly for classes, variables, etc. Now, in those methods, we can easily insert a check to see if a name matches with any of the regex then we should ignore that construct.</p> <p>The implementation for this was very easy, but there was a whole new problem - How do we present this functionality to the user?</p> <p>All the inputs in Vulture are supplied through command line arguments and there aren’t any config files or variables (because that would be an overkill for such a simple tool). Although passing regex through a cli argument is possibe, seeking that it would be a non trivial task to write such a command and that there would be way too many different permutations of “lists” of regex for all the different types of constructs (functions, classes, variables, methods, properties, etc.), we soon dropped the idea.</p> <h3 id="approach-2---using-xml-output-from-coveragepy">Approach 2 - Using XML output from <code class="highlighter-rouge">coverage.py</code></h3> <p>Now, since we were restricted to minimum user interaction, Jendrik came up with this brilliant idea of automatically generating an initial whitelist and then letting user adapt it to her needs. This lead us to think that we should let user run <a href="http://coverage.readthedocs.io/"><code class="highlighter-rouge">coverage.py</code></a> on their code base and export the XML output which could then be consumed by Vulture to detect which lines are actually used.</p> <p>So, we tried a basic prototype. We took a sample file, let’s say <code class="highlighter-rouge">ab.py</code>:</p> <div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="nd">@a</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div> <p>Running <code class="highlighter-rouge">coverage.py</code>, the following XML output was observed:</p> <div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" ?&gt;</span>
<span class="nt">&lt;coverage</span> <span class="na">branch-rate=</span><span class="s">"0"</span> <span class="na">line-rate=</span><span class="s">"0.75"</span> <span class="na">timestamp=</span><span class="s">"1524751600489"</span> <span class="na">version=</span><span class="s">"4.3.4"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Generated by coverage.py: https://coverage.readthedocs.io --&gt;</span>
    <span class="c">&lt;!-- Based on https://raw.githubusercontent.com/cobertura/web/f0366e5e2cf18f111cbd61fc34ef720a6584ba02/htdocs/xml/coverage-03.dtd --&gt;</span>
    <span class="nt">&lt;sources&gt;</span>
        <span class="nt">&lt;source&gt;</span>/Users/rahuljha/Documents/test_everything_here<span class="nt">&lt;/source&gt;</span>
    <span class="nt">&lt;/sources&gt;</span>
    <span class="nt">&lt;packages&gt;</span>
        <span class="nt">&lt;package</span> <span class="na">branch-rate=</span><span class="s">"0"</span> <span class="na">complexity=</span><span class="s">"0"</span> <span class="na">line-rate=</span><span class="s">"0.75"</span> <span class="na">name=</span><span class="s">"."</span><span class="nt">&gt;</span>
            <span class="nt">&lt;classes&gt;</span>
                <span class="nt">&lt;class</span> <span class="na">branch-rate=</span><span class="s">"0"</span> <span class="na">complexity=</span><span class="s">"0"</span> <span class="na">filename=</span><span class="s">"ab.py"</span> <span class="na">line-rate=</span><span class="s">"0.75"</span> <span class="na">name=</span><span class="s">"ab.py"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;methods/&gt;</span>
                    <span class="nt">&lt;lines&gt;</span>
                        <span class="nt">&lt;line</span> <span class="na">hits=</span><span class="s">"1"</span> <span class="na">number=</span><span class="s">"1"</span><span class="nt">/&gt;</span>
                        <span class="nt">&lt;line</span> <span class="na">hits=</span><span class="s">"1"</span> <span class="na">number=</span><span class="s">"2"</span><span class="nt">/&gt;</span>
                        <span class="nt">&lt;line</span> <span class="na">hits=</span><span class="s">"1"</span> <span class="na">number=</span><span class="s">"4"</span><span class="nt">/&gt;</span>
                        <span class="nt">&lt;line</span> <span class="na">hits=</span><span class="s">"0"</span> <span class="na">number=</span><span class="s">"6"</span><span class="nt">/&gt;</span>
                    <span class="nt">&lt;/lines&gt;</span>
                <span class="nt">&lt;/class&gt;</span>
            <span class="nt">&lt;/classes&gt;</span>
        <span class="nt">&lt;/package&gt;</span>
    <span class="nt">&lt;/packages&gt;</span>
<span class="nt">&lt;/coverage&gt;</span>
</code></pre></div> <p>Now, as you may have observed, the problem with this was that the line numbers were not accurate (function <code class="highlighter-rouge">b</code> starts at line number 6, but according to the report, line only line number 6 is unused) and no information about the name of the unused code was provided. So, we discraded this idea and decided to go yet more bare bones and to write a tracer.</p> <h3 id="approach-3---writing-a-tracer">Approach 3 - Writing a <code class="highlighter-rouge">tracer</code></h3> <p>A tracer would allow us to keep track of what is going on in the current Python process, but after trying to develop a simple protoype, I knew that it wasn’t a trivial task. Also, Abdeali who have had previous experience working with such “technology” held the following opinion:</p> <blockquote> <p>If vulture starts to maintain tracer and so on it is starting to go towards non-static analysis which I am not sure you guys want to maintain as it can have a bunch of issues :/</p> </blockquote> <p>So, in this moment of confusion, we decided to ask Ned Batchelder, the guy behind <code class="highlighter-rouge">coverage.py</code> himself. Let me quote him:</p> <blockquote> <p>You will need a trace function. Writing your own doesn’t have to be complicated, though you are right there are details like subprocesses that can be a pain. Writing a file tracer plugin could be a way to piggy-back on coverage.py. Getting function names wouldn’t be hard, since you can inspect the frame object in the trace function to get what you need. Variables are harder. You’ve noted that coverage.py reports line numbers, but then you say it’s hard to go from line numbers to the information you need. But you already are doing AST analysis. Couldn’t you use coverage.py’s line numbers to index into the AST you already have, and then use your AST expertise from there?</p> </blockquote> <p>So, we were back to square one (well, square two in this case) - Use output from <code class="highlighter-rouge">coverage.xml</code></p> <h3 id="back-to-approach-2---use-xml-output-from-coveragepy">Back to approach 2 - Use XML output from <code class="highlighter-rouge">coverage.py</code></h3> <p>We quickly discovered that <code class="highlighter-rouge">&lt;line hits="1"&gt;</code> was merely a binary switch indicative of whether or not that line was called and contained no information about “how many times”. It was important because it would always be “1” for the first line of function (It is used when the program is initialised to store the name of the function in memory) and therefore we couldn’t use this switch as an indication of whether or not the function was actually used. This also explained why the line numbers were off when we inspected the output earlier.</p> <p>But, this gave us a workable idea: If Vulture says that a function is unused, we can check whether this is really the case by checking whether the next line is marked as unused in the coverage.py XML file. The only exception would be a function defined in a single line, such as:</p> <div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">true</span><span class="p">():</span> <span class="k">return</span> <span class="bp">True</span>
</code></pre></div> <p>which aren’t very common nor very useful and therefore can be neglected.</p> <p>And that’s how my dear friends we decided to use <code class="highlighter-rouge">coverage.py</code> to detect if code was actually used or not. Although, it would only enable vulture to detect unused “functions” (and properties, maybe) and not classes or variable, but it would still be a very useful feature.</p> <p>P.S. I am excited to work with the team on this feature. It is also one of the goals of my Google Summer of Code project.</p> <div id="more"> <div id="more-articles"> <p> If you liked this, feel free to <a href="/blog">browse other articles on my blog</a>. </p> </div> <a href="https://twitter.com/rahul722j" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @rahul722j</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script> <a href="https://twitter.com/share" class="twitter-share-button" data-via="rahul722j" data-size="large">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script> </div> <div id="comments"> <style id="disqus_hide"> #disqus_thread{ display: none; } </style> <p> <span id="show-disqus-arrow">&rarr; </span> <a href="#" id="show-disqus">Read the comments or contribute with your own</a> </p> <div id="disqus_thread"></div> </div> <script type="text/javascript"> var disqus_shortname = 'rahuljharj722'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> </div> </div> </div> <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> <script src="/assets/js/comments.js"></script> <link rel="preload" href="/assets/css/code.css" as="style" onload="this.rel='stylesheet'"> <script> /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */ !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); /*! loadCSS rel=preload polyfill. [c]2017 Filament Group, Inc. MIT License */ !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); </script> <footer> <div>Website powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a>, hosted on <a href="https://github.com/RJ722/rj722.github.io">Github</a> and put together by <a href="http://twitter.com/marcgg">@marcgg</a>.</div> <div>All of the <a href="/blog">blog's articles</a> are under <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative commons</a> license unless stated otherwise. Everything else is &copy;.</div> </footer> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-31071519-1']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </body> </html>

